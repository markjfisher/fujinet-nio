<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="634px" preserveAspectRatio="none" style="width:1035px;height:634px;" version="1.1" viewBox="0 0 1035 634" width="1035px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="346" x="347.5" y="16.708">FujiBus Packet Format + SLIP Encoding</text><!--MD5=[4b10db4d846f53b454d397d5b71c50a1]
cluster fujinet::io::protocol--><rect fill="#FFFFFF" height="579" style="stroke: #000000; stroke-width: 1.5;" width="634" x="22" y="44.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="262" y="59.9482">fujinet::io::protocol</text><!--MD5=[dcd864e1504f737b7757b66bf313694a]
class ByteBuffer--><rect fill="#FEFECE" height="112.0234" id="ByteBuffer" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="318.5" y="319.9531"/><ellipse cx="350.15" cy="335.9531" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M353.1188,341.5938 Q352.5406,341.8906 351.9,342.0313 Q351.2594,342.1875 350.5563,342.1875 Q348.0563,342.1875 346.7281,340.5469 Q345.4156,338.8906 345.4156,335.7656 Q345.4156,332.6406 346.7281,330.9844 Q348.0563,329.3281 350.5563,329.3281 Q351.2594,329.3281 351.9,329.4844 Q352.5563,329.6406 353.1188,329.9375 L353.1188,332.6563 Q352.4938,332.0781 351.9,331.8125 Q351.3063,331.5313 350.6813,331.5313 Q349.3375,331.5313 348.65,332.6094 Q347.9625,333.6719 347.9625,335.7656 Q347.9625,337.8594 348.65,338.9375 Q349.3375,340 350.6813,340 Q351.3063,340 351.9,339.7344 Q352.4938,339.4531 353.1188,338.875 L353.1188,341.5938 Z "/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="64" x="367.85" y="340.1074">ByteBuffer</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="319.5" x2="450.5" y1="351.9531" y2="351.9531"/><ellipse cx="329.5" cy="362.9531" fill="none" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="107" x="338.5" y="366.1636">operator[] : uint8_t</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="319.5" x2="450.5" y1="372.7578" y2="372.7578"/><ellipse cx="329.5" cy="383.7578" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="74" x="338.5" y="386.9683">size() : size_t</text><ellipse cx="329.5" cy="396.5625" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="106" x="338.5" y="399.7729">push_back(uint8_t)</text><ellipse cx="329.5" cy="409.3672" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="53" x="338.5" y="412.5776">insert(...)</text><ellipse cx="329.5" cy="422.1719" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="64" x="338.5" y="425.3823">reserve(...)</text><!--MD5=[1d13d8976171cead106513767ffc25b7]
class SlipByte--><rect fill="#FEFECE" height="99.2188" id="SlipByte" style="stroke: #A80036; stroke-width: 1.5;" width="99" x="178.5" y="508.9531"/><ellipse cx="201.6" cy="524.9531" fill="#EB937F" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M205.7094,530.9531 L197.9906,530.9531 L197.9906,518.5625 L205.7094,518.5625 L205.7094,520.7188 L200.4438,520.7188 L200.4438,523.3906 L205.2094,523.3906 L205.2094,525.5469 L200.4438,525.5469 L200.4438,528.7969 L205.7094,528.7969 L205.7094,530.9531 Z "/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="49" x="217.4" y="529.1074">SlipByte</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="179.5" x2="276.5" y1="540.9531" y2="540.9531"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="66" x="184.5" y="555.1636">End = 0xC0</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="87" x="184.5" y="567.9683">Escape = 0xDB</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="87" x="184.5" y="580.7729">EscEnd = 0xDC</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="86" x="184.5" y="593.5776">EscEsc = 0xDD</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="179.5" x2="276.5" y1="600.1719" y2="600.1719"/><!--MD5=[fbbf9c7ceeba3032ced297388869331c]
class ToByte--><rect fill="#FEFECE" height="60.8047" id="ToByte" style="stroke: #A80036; stroke-width: 1.5;" width="245" x="38.5" y="345.4531"/><ellipse cx="122.75" cy="361.4531" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M125.7188,367.0938 Q125.1406,367.3906 124.5,367.5313 Q123.8594,367.6875 123.1563,367.6875 Q120.6563,367.6875 119.3281,366.0469 Q118.0156,364.3906 118.0156,361.2656 Q118.0156,358.1406 119.3281,356.4844 Q120.6563,354.8281 123.1563,354.8281 Q123.8594,354.8281 124.5,354.9844 Q125.1563,355.1406 125.7188,355.4375 L125.7188,358.1563 Q125.0938,357.5781 124.5,357.3125 Q123.9063,357.0313 123.2813,357.0313 Q121.9375,357.0313 121.25,358.1094 Q120.5625,359.1719 120.5625,361.2656 Q120.5625,363.3594 121.25,364.4375 Q121.9375,365.5 123.2813,365.5 Q123.9063,365.5 124.5,365.2344 Q125.0938,364.9531 125.7188,364.375 L125.7188,367.0938 Z "/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="68" x="143.25" y="365.6074">to_byte(...)</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="39.5" x2="282.5" y1="377.4531" y2="377.4531"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="39.5" x2="282.5" y1="385.4531" y2="385.4531"/><ellipse cx="49.5" cy="396.4531" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="219" x="58.5" y="399.6636">to_byte(SlipByte) : uint8_t «constexpr»</text><!--MD5=[a3732e893a63f16364b153ebbd6adbb4]
class PacketParam--><rect fill="#FEFECE" height="73.6094" id="PacketParam" style="stroke: #A80036; stroke-width: 1.5;" width="153" x="486.5" y="338.9531"/><ellipse cx="518.6" cy="354.9531" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M521.5688,360.5938 Q520.9906,360.8906 520.35,361.0313 Q519.7094,361.1875 519.0063,361.1875 Q516.5063,361.1875 515.1781,359.5469 Q513.8656,357.8906 513.8656,354.7656 Q513.8656,351.6406 515.1781,349.9844 Q516.5063,348.3281 519.0063,348.3281 Q519.7094,348.3281 520.35,348.4844 Q521.0063,348.6406 521.5688,348.9375 L521.5688,351.6563 Q520.9438,351.0781 520.35,350.8125 Q519.7563,350.5313 519.1313,350.5313 Q517.7875,350.5313 517.1,351.6094 Q516.4125,352.6719 516.4125,354.7656 Q516.4125,356.8594 517.1,357.9375 Q517.7875,359 519.1313,359 Q519.7563,359 520.35,358.7344 Q520.9438,358.4531 521.5688,357.875 L521.5688,360.5938 Z "/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="83" x="536.4" y="359.1074">PacketParam</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="487.5" x2="638.5" y1="370.9531" y2="370.9531"/><ellipse cx="497.5" cy="381.9531" fill="none" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="87" x="506.5" y="385.1636">value : uint32_t</text><ellipse cx="497.5" cy="394.7578" fill="none" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="127" x="506.5" y="397.9683">size  : uint8_t  «1,2,4»</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="487.5" x2="638.5" y1="404.5625" y2="404.5625"/><!--MD5=[773ffb48f768ed83eeabad13efcba9c6]
class FujiBusPacket--><rect fill="#FEFECE" height="163.2422" id="FujiBusPacket" style="stroke: #A80036; stroke-width: 1.5;" width="272" x="366" y="79.9531"/><ellipse cx="454.25" cy="95.9531" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M457.2188,101.5938 Q456.6406,101.8906 456,102.0313 Q455.3594,102.1875 454.6563,102.1875 Q452.1563,102.1875 450.8281,100.5469 Q449.5156,98.8906 449.5156,95.7656 Q449.5156,92.6406 450.8281,90.9844 Q452.1563,89.3281 454.6563,89.3281 Q455.3594,89.3281 456,89.4844 Q456.6563,89.6406 457.2188,89.9375 L457.2188,92.6563 Q456.5938,92.0781 456,91.8125 Q455.4063,91.5313 454.7813,91.5313 Q453.4375,91.5313 452.75,92.6094 Q452.0625,93.6719 452.0625,95.7656 Q452.0625,97.8594 452.75,98.9375 Q453.4375,100 454.7813,100 Q455.4063,100 456,99.7344 Q456.5938,99.4531 457.2188,98.875 L457.2188,101.5938 Z "/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="87" x="474.75" y="100.1074">FujiBusPacket</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="367" x2="637" y1="111.9531" y2="111.9531"/><rect fill="none" height="6" style="stroke: #C82930; stroke-width: 1.0;" width="6" x="374" y="119.9531"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="86" x="386" y="126.1636">device : uint8_t</text><rect fill="none" height="6" style="stroke: #C82930; stroke-width: 1.0;" width="6" x="374" y="132.7578"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="106" x="386" y="138.9683">command : uint8_t</text><rect fill="none" height="6" style="stroke: #C82930; stroke-width: 1.0;" width="6" x="374" y="145.5625"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="209" x="386" y="151.7729">params : std::vector&lt;PacketParam&gt;</text><rect fill="none" height="6" style="stroke: #C82930; stroke-width: 1.0;" width="6" x="374" y="158.3672"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="103" x="386" y="164.5776">data : ByteBuffer?</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="367" x2="637" y1="171.1719" y2="171.1719"/><ellipse cx="377" cy="182.1719" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="127" x="386" y="185.3823">serialize() : ByteBuffer</text><ellipse cx="377" cy="194.9766" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="205" x="386" y="198.187">decodeSLIP(ByteBuffer) : ByteBuffer</text><ellipse cx="377" cy="207.7813" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="205" x="386" y="210.9917">encodeSLIP(ByteBuffer) : ByteBuffer</text><ellipse cx="377" cy="220.5859" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="199" x="386" y="223.7964">calcChecksum(ByteBuffer) : uint8_t</text><ellipse cx="377" cy="233.3906" fill="#84BE84" rx="3" ry="3" style="stroke: #038048; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="246" x="386" y="236.6011">fromSerialized(ByteBuffer) : FujiBusPacket*</text><path d="M673,95.9531 L673,157.4531 L638.17,161.4531 L673,165.4531 L673,227.0156 A0,0 0 0 0 673,227.0156 L1023,227.0156 A0,0 0 0 0 1023,227.0156 L1023,105.9531 L1013,95.9531 L673,95.9531 A0,0 0 0 0 673,95.9531 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1013,95.9531 L1013,105.9531 L1023,105.9531 L1013,95.9531 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="679" y="113.02">FujiBus Header (6 bytes):</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="687" y="128.1528">struct {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="695" y="143.2856">uint8_t  device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="695" y="158.4185">uint8_t  command</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="695" y="173.5513">uint16_t length   ; includes header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="695" y="188.6841">uint8_t  checksum ; entire frame w/ checksum=0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="695" y="203.8169">uint8_t  descr    ; descriptor for params</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="687" y="218.9497">}</text><path d="M671.5,522.9531 L671.5,593.4844 A0,0 0 0 0 671.5,593.4844 L996.5,593.4844 A0,0 0 0 0 996.5,593.4844 L996.5,532.9531 L986.5,522.9531 L785.75,522.9531 L617.19,413.0431 L777.75,522.9531 L671.5,522.9531 A0,0 0 0 0 671.5,522.9531 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M986.5,522.9531 L986.5,532.9531 L996.5,532.9531 L986.5,522.9531 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="677.5" y="540.02">Parameter descriptors define:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="681.5" y="555.1528">- how many params follow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="681.5" y="570.2856">- each param’s byte width (1,2,4)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="677.5" y="585.4185">Multiple descriptors may be chained using bit 7.</text><!--MD5=[80cec02a14a74af19789c43faf6f3e41]
link ByteBuffer to SlipByte--><path d="M337.04,432.0931 C316.92,455.2231 293.64,481.9931 273.76,504.8431 " fill="none" id="ByteBuffer-&gt;SlipByte" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="270.34,508.7731,279.2589,504.5955,273.6163,504.9961,273.2157,499.3534,270.34,508.7731" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="307" y="475.02">uses</text><polygon fill="#000000" points="317.5,484.0859,320.5,490.0859,323.5,484.0859,317.5,484.0859" style="stroke: #000000; stroke-width: 1.0;"/><!--MD5=[ddd68783ec8827ba93b4408892583b91]
link ToByte to SlipByte--><path d="M172.06,406.7631 C181.84,433.0831 196.32,472.1131 208.11,503.8531 " fill="none" id="ToByte-&gt;SlipByte" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="209.97,508.8831,210.6079,499.0549,208.2395,504.1921,203.1023,501.8238,209.97,508.8831" style="stroke: #A80036; stroke-width: 1.0;"/><!--MD5=[f1b34054b33fa4f7ce72df8bc9f11dde]
link FujiBusPacket to PacketParam--><path d="M525.15,243.0931 C534.03,274.0231 543.79,308.0331 551.18,333.7631 " fill="none" id="FujiBusPacket-&gt;PacketParam" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="552.62,338.7931,553.9936,329.0405,551.2464,333.9855,546.3014,331.2383,552.62,338.7931" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="538" y="286.02">contains</text><polygon fill="#000000" points="560.5,295.0859,563.5,301.0859,566.5,295.0859,560.5,295.0859" style="stroke: #000000; stroke-width: 1.0;"/><!--MD5=[f59b4f2f02669c8d57ac3269c37434da]
link FujiBusPacket to ByteBuffer--><path d="M457.6,243.0931 C444.39,267.0931 430.16,292.9431 417.82,315.3331 " fill="none" id="FujiBusPacket-&gt;ByteBuffer" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="415.38,319.7731,423.2244,313.8178,417.7912,315.3929,416.2161,309.9598,415.38,319.7731" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="440" y="286.02">uses</text><polygon fill="#000000" points="450.5,295.0859,453.5,301.0859,456.5,295.0859,450.5,295.0859" style="stroke: #000000; stroke-width: 1.0;"/><!--MD5=[6b95393626d163eee5658a89f498177f]
@startuml ProtocolFujiBus
title FujiBus Packet Format + SLIP Encoding

skinparam shadowing false
skinparam packageStyle rectangle

package "fujinet::io::protocol" {

    class ByteBuffer {
        + size() : size_t
        + operator[] : uint8_t
        + push_back(uint8_t)
        + insert(...)
        + reserve(...)
    }

    enum SlipByte {
        End = 0xC0
        Escape = 0xDB
        EscEnd = 0xDC
        EscEsc = 0xDD
    }

    class "to_byte(...)" as ToByte {
        + to_byte(SlipByte) : uint8_t <<constexpr>>
    }

    ByteBuffer - -> SlipByte : uses >
    ToByte - -> SlipByte
}

package "fujinet::io::protocol" {

    class PacketParam {
        + value : uint32_t
        + size  : uint8_t  <<1,2,4>>
    }

    class FujiBusPacket {
        - device : uint8_t
        - command : uint8_t
        - params : std::vector<PacketParam>
        - data : ByteBuffer?

        + serialize() : ByteBuffer
        + decodeSLIP(ByteBuffer) : ByteBuffer
        + encodeSLIP(ByteBuffer) : ByteBuffer
        + calcChecksum(ByteBuffer) : uint8_t
        + fromSerialized(ByteBuffer) : FujiBusPacket*
    }

    FujiBusPacket - -> PacketParam : contains >
    FujiBusPacket - -> ByteBuffer : uses >
}

note right of FujiBusPacket
FujiBus Header (6 bytes):
  struct {
    uint8_t  device
    uint8_t  command
    uint16_t length   ; includes header
    uint8_t  checksum ; entire frame w/ checksum=0
    uint8_t  descr    ; descriptor for params
  }
end note

note bottom of PacketParam
Parameter descriptors define:
 - how many params follow
 - each param’s byte width (1,2,4)
Multiple descriptors may be chained using bit 7.
end note

@enduml

PlantUML version 1.2020.02(Sun Mar 01 10:22:07 UTC 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 17.0.17+10
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>