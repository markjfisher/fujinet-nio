<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1208px" preserveAspectRatio="none" style="width:1927px;height:1208px;" version="1.1" viewBox="0 0 1927 1208" width="1927px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="414" x="752" y="26.708">Full request/response path over FujiBus + SLIP</text><rect fill="#FFFFFF" height="681.0547" style="stroke: #000000; stroke-width: 2.0;" width="1892" x="13" y="423.4453"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="42" x2="42" y1="117.25" y2="1121.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="316" x2="316" y1="117.25" y2="1121.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="492" x2="492" y1="117.25" y2="1121.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="680" x2="680" y1="117.25" y2="1121.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="981" x2="981" y1="117.25" y2="1121.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1159.5" x2="1159.5" y1="117.25" y2="1121.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1380.5" x2="1380.5" y1="117.25" y2="1121.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1585" x2="1585" y1="117.25" y2="1121.5"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1779" x2="1779" y1="117.25" y2="1121.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="23" y="113.9482">Host</text><ellipse cx="42" cy="47.9531" fill="#FEFECE" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M42,55.9531 L42,82.9531 M29,63.9531 L55,63.9531 M42,82.9531 L29,97.9531 M42,82.9531 L55,97.9531 " fill="none" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="23" y="1133.4951">Host</text><ellipse cx="42" cy="1146.7969" fill="#FEFECE" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M42,1154.7969 L42,1181.7969 M29,1162.7969 L55,1162.7969 M42,1181.7969 L29,1196.7969 M42,1181.7969 L55,1196.7969 " fill="none" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="263" y="69.6563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="270" y="89.6514">/dev/ttyACM1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="288.5" y="105.9482">(or PTY)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="263" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="270" y="1140.4951">/dev/ttyACM1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="288.5" y="1156.792">(or PTY)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="226" x="379" y="69.6563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="463.5" y="89.6514">Channel</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="212" x="386" y="105.9482">(UsbCdcChannel / PtyChannel)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="226" x="379" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="463.5" y="1140.4951">Channel</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="212" x="386" y="1156.792">(UsbCdcChannel / PtyChannel)</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="131" x="615" y="85.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="117" x="622" y="105.9482">FujiBusTransport</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="131" x="615" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="117" x="622" y="1140.4951">FujiBusTransport</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="935" y="85.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="942" y="105.9482">FujinetCore</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="935" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="942" y="1140.4951">FujinetCore</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="1120.5" y="85.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="1127.5" y="105.9482">IOService</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="1120.5" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="1127.5" y="1140.4951">IOService</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1316.5" y="85.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="1323.5" y="105.9482">RoutingManager</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1316.5" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="114" x="1323.5" y="1140.4951">RoutingManager</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="135" x="1518" y="85.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="121" x="1525" y="105.9482">IODeviceManager</text><rect fill="#FEFECE" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="135" x="1518" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="121" x="1525" y="1140.4951">IODeviceManager</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="232" x="1663" y="69.6563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="1734.5" y="89.6514">VirtualDevice</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="218" x="1670" y="105.9482">(e.g. DummyDevice, FujiDevice)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="232" x="1663" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="1734.5" y="1140.4951">VirtualDevice</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="218" x="1670" y="1156.792">(e.g. DummyDevice, FujiDevice)</text><rect fill="#EEEEEE" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1912" x="3" y="147.8164"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1915" y1="147.8164" y2="147.8164"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1915" y1="150.8164" y2="150.8164"/><rect fill="#EEEEEE" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="251" x="833.5" y="137.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="232" x="839.5" y="153.3169">Host sends FujiBus+SLIP frame</text><polygon fill="#A80036" points="304,202.6484,314,206.6484,304,210.6484,308,206.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="42" x2="310" y1="206.6484" y2="206.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="49" y="186.4497">write SLIP-framed FujiBus packet</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="49" y="201.5825">(deviceId, command, params, payload)</text><polygon fill="#A80036" points="480,231.7813,490,235.7813,480,239.7813,484,235.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="316" x2="486" y1="235.7813" y2="235.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="323" y="230.7153">bytes arrive</text><rect fill="#EEEEEE" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1912" x="3" y="264.3477"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1915" y1="264.3477" y2="264.3477"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1915" y1="267.3477" y2="267.3477"/><rect fill="#EEEEEE" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="122" x="898" y="253.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="904" y="269.8481">Core tick loop</text><polygon fill="#A80036" points="691.5,304.0469,681.5,308.0469,691.5,312.0469,687.5,308.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="980.5" y1="308.0469" y2="308.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="697.5" y="302.981">poll()</text><polygon fill="#A80036" points="503,333.1797,493,337.1797,503,341.1797,499,337.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="679.5" y1="337.1797" y2="337.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="509" y="332.1138">available() / read()</text><polygon fill="#A80036" points="668.5,362.3125,678.5,366.3125,668.5,370.3125,672.5,366.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="492" x2="674.5" y1="366.3125" y2="366.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="499" y="361.2466">raw bytes</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="680.5" x2="722.5" y1="395.4453" y2="395.4453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="722.5" x2="722.5" y1="395.4453" y2="408.4453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="722.5" y1="408.4453" y2="408.4453"/><polygon fill="#A80036" points="691.5,404.4453,681.5,408.4453,691.5,412.4453,687.5,408.4453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="687.5" y="390.3794">append bytes to _rxBuffer</text><path d="M13,423.4453 L90,423.4453 L90,430.4453 L80,440.4453 L13,440.4453 L13,423.4453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="681.0547" style="stroke: #000000; stroke-width: 2.0;" width="1892" x="13" y="423.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="28" y="436.5122">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="250" x="105" y="435.6558">[while complete SLIP frame(s) present]</text><polygon fill="#A80036" points="691.5,457.7109,681.5,461.7109,691.5,465.7109,687.5,461.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="980.5" y1="461.7109" y2="461.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="697.5" y="456.645">receive(out IORequest)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="680.5" x2="722.5" y1="490.8438" y2="490.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="722.5" x2="722.5" y1="490.8438" y2="503.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="722.5" y1="503.8438" y2="503.8438"/><polygon fill="#A80036" points="691.5,499.8438,681.5,503.8438,691.5,507.8438,687.5,503.8438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="687.5" y="485.7778">extract SLIP frame from _rxBuffer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="680.5" x2="722.5" y1="532.9766" y2="532.9766"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="722.5" x2="722.5" y1="532.9766" y2="545.9766"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="722.5" y1="545.9766" y2="545.9766"/><polygon fill="#A80036" points="691.5,541.9766,681.5,545.9766,691.5,549.9766,687.5,545.9766" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="687.5" y="527.9106">FujiBusPacket::fromSerialized(frame)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="680.5" x2="722.5" y1="605.375" y2="605.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="722.5" x2="722.5" y1="605.375" y2="618.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="722.5" y1="618.375" y2="618.375"/><polygon fill="#A80036" points="691.5,614.375,681.5,618.375,691.5,622.375,687.5,618.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="687.5" y="570.0435">build IORequest</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="687.5" y="585.1763">(id, deviceId, type, command,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="687.5" y="600.3091">params, payload)</text><polygon fill="#A80036" points="969.5,643.5078,979.5,647.5078,969.5,651.5078,973.5,647.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="680.5" x2="975.5" y1="647.5078" y2="647.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="687.5" y="642.4419">IORequest</text><polygon fill="#A80036" points="1147.5,672.6406,1157.5,676.6406,1147.5,680.6406,1151.5,676.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="981.5" x2="1153.5" y1="676.6406" y2="676.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="988.5" y="671.5747">handleRequest(request)</text><polygon fill="#A80036" points="1368.5,701.7734,1378.5,705.7734,1368.5,709.7734,1372.5,705.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1159.5" x2="1374.5" y1="705.7734" y2="705.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="1166.5" y="700.7075">selectDevice(request, DevMgr)</text><polygon fill="#A80036" points="1573.5,730.9063,1583.5,734.9063,1573.5,738.9063,1577.5,734.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1380.5" x2="1579.5" y1="734.9063" y2="734.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="1387.5" y="729.8403">findDevice(request.deviceId)</text><polygon fill="#A80036" points="1391.5,760.0391,1381.5,764.0391,1391.5,768.0391,1387.5,764.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1385.5" x2="1584.5" y1="764.0391" y2="764.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="1397.5" y="758.9731">VirtualDevice*</text><polygon fill="#A80036" points="1170.5,789.1719,1160.5,793.1719,1170.5,797.1719,1166.5,793.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1164.5" x2="1379.5" y1="793.1719" y2="793.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="1176.5" y="788.106">selected VirtualDevice</text><polygon fill="#A80036" points="1767,818.3047,1777,822.3047,1767,826.3047,1771,822.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1159.5" x2="1773" y1="822.3047" y2="822.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="1166.5" y="817.2388">handle(request)</text><polygon fill="#A80036" points="1170.5,847.4375,1160.5,851.4375,1170.5,855.4375,1166.5,851.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1164.5" x2="1778" y1="851.4375" y2="851.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="1176.5" y="846.3716">IOResponse</text><polygon fill="#A80036" points="992.5,876.5703,982.5,880.5703,992.5,884.5703,988.5,880.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="986.5" x2="1158.5" y1="880.5703" y2="880.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="998.5" y="875.5044">IOResponse</text><polygon fill="#A80036" points="691.5,905.7031,681.5,909.7031,691.5,913.7031,687.5,909.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="980.5" y1="909.7031" y2="909.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="697.5" y="904.6372">send(response)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="680.5" x2="722.5" y1="953.9688" y2="953.9688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="722.5" x2="722.5" y1="953.9688" y2="966.9688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="722.5" y1="966.9688" y2="966.9688"/><polygon fill="#A80036" points="691.5,962.9688,681.5,966.9688,691.5,970.9688,687.5,966.9688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="687.5" y="933.77">map IOResponse -&gt; FujiBusPacket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="687.5" y="948.9028">(deviceId, command, status param, payload)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="680.5" x2="722.5" y1="996.1016" y2="996.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="722.5" x2="722.5" y1="996.1016" y2="1009.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="722.5" y1="1009.1016" y2="1009.1016"/><polygon fill="#A80036" points="691.5,1005.1016,681.5,1009.1016,691.5,1013.1016,687.5,1009.1016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="687.5" y="991.0356">packet.serialize() -&gt; SLIP bytes</text><polygon fill="#A80036" points="503,1034.2344,493,1038.2344,503,1042.2344,499,1038.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="679.5" y1="1038.2344" y2="1038.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="509" y="1033.1685">write(SLIP bytes)</text><polygon fill="#A80036" points="327,1063.3672,317,1067.3672,327,1071.3672,323,1067.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="321" x2="491" y1="1067.3672" y2="1067.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="333" y="1062.3013">bytes out</text><polygon fill="#A80036" points="53,1092.5,43,1096.5,53,1100.5,49,1096.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="47" x2="315" y1="1096.5" y2="1096.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="59" y="1091.4341">SLIP-framed response</text><!--MD5=[cb571816a9b00f2d5f7f40837611f031]
@startuml RequestResponseFlow
title Full request/response path over FujiBus + SLIP

skinparam shadowing false

actor Host as Host
participant "/dev/ttyACM1\n(or PTY)" as Serial
participant "Channel\n(UsbCdcChannel / PtyChannel)" as Channel
participant "FujiBusTransport" as Transport
participant "FujinetCore" as Core
participant "IOService" as IOService
participant "RoutingManager" as Router
participant "IODeviceManager" as DevMgr
participant "VirtualDevice\n(e.g. DummyDevice, FujiDevice)" as Device

== Host sends FujiBus+SLIP frame ==

Host -> Serial : write SLIP-framed FujiBus packet\n(deviceId, command, params, payload)
Serial -> Channel : bytes arrive

== Core tick loop ==

Core -> Transport : poll()
Transport -> Channel : available() / read()
Channel - -> Transport : raw bytes
Transport -> Transport : append bytes to _rxBuffer

loop while complete SLIP frame(s) present
  Core -> Transport : receive(out IORequest)
  Transport -> Transport : extract SLIP frame from _rxBuffer
  Transport -> Transport : FujiBusPacket::fromSerialized(frame)
  Transport -> Transport : build IORequest\n(id, deviceId, type, command,\nparams, payload)

  Transport - -> Core : IORequest

  Core -> IOService : handleRequest(request)
  IOService -> Router : selectDevice(request, DevMgr)
  Router -> DevMgr : findDevice(request.deviceId)
  DevMgr - -> Router : VirtualDevice*
  Router - -> IOService : selected VirtualDevice

  IOService -> Device : handle(request)
  Device - -> IOService : IOResponse
  IOService - -> Core : IOResponse

  Core -> Transport : send(response)
  Transport -> Transport : map IOResponse -> FujiBusPacket\n(deviceId, command, status param, payload)
  Transport -> Transport : packet.serialize() -> SLIP bytes
  Transport -> Channel : write(SLIP bytes)
  Channel -> Serial : bytes out

  Serial - -> Host : SLIP-framed response
end

@enduml

PlantUML version 1.2020.02(Sun Mar 01 10:22:07 UTC 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 17.0.17+10
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>