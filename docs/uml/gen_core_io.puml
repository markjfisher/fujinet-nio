@startuml
title Core + IO (auto-gen from clang-uml)
enum "io::RequestType" as C_0015173710654558847960
enum C_0015173710654558847960 {
Command
Read
Write
Open
Close
Control
}
class "io::IORequest" as C_0002386736627821114488
class C_0002386736627821114488 {
__
+command : std::uint16_t
+deviceId : DeviceID
+id : RequestID
+params : std::vector<std::uint32_t>
+payload : std::vector<std::uint8_t>
+type : RequestType
}
enum "io::StatusCode" as C_0012496700434923238249
enum C_0012496700434923238249 {
Ok
DeviceNotFound
InvalidRequest
DeviceBusy
NotReady
IOError
Timeout
InternalError
Unsupported
}
class "io::IOResponse" as C_0002942984525013396621
class C_0002942984525013396621 {
__
+command : std::uint16_t
+deviceId : DeviceID
+id : RequestID
+payload : std::vector<std::uint8_t>
+status : StatusCode
}
class "io::NetworkOpenRequest" as C_0001159279330674149840
class C_0001159279330674149840 {
__
+bodyLenHint : std::uint32_t
+flags : std::uint8_t
+headers : std::vector<std::pair<std::string,std::string>>
+method : std::uint8_t
+responseHeaderNamesLower : std::vector<std::string>
+url : std::string
}
class "io::NetworkInfo" as C_0007100525671922339382
class C_0007100525671922339382 {
__
+contentLength : std::uint64_t
+hasContentLength : bool
+hasHttpStatus : bool
+headersBlock : std::string
+httpStatus : std::uint16_t
}
abstract "io::INetworkProtocol" as C_0010613333864250568344
abstract C_0010613333864250568344 {
+~INetworkProtocol() constexpr = default : void
..
{abstract} +close() = 0 : void
{abstract} +info(NetworkInfo & out) = 0 : StatusCode
{abstract} +open(const NetworkOpenRequest & req) = 0 : StatusCode
{abstract} +poll() = 0 : void
{abstract} +read_body(std::uint32_t offset, std::uint8_t * out, std::size_t outLen, std::uint16_t & read, bool & eof) = 0 : StatusCode
{abstract} +write_body(std::uint32_t offset, const std::uint8_t * data, std::size_t dataLen, std::uint16_t & written) = 0 : StatusCode
__
}
abstract "io::IRequestHandler" as C_0007350464861923755413
abstract C_0007350464861923755413 {
+~IRequestHandler() constexpr = default : void
..
{abstract} +handleRequest(const IORequest & request) = 0 : IOResponse
__
}
abstract "io::VirtualDevice" as C_0010069830097413987109
abstract C_0010069830097413987109 {
+~VirtualDevice() constexpr = default : void
..
{abstract} +handle(const IORequest & request) = 0 : IOResponse
+poll() : void
__
}
class "io::IODeviceManager" as C_0010794218937492142358
class C_0010794218937492142358 {
+IODeviceManager() = default : void
+IODeviceManager(const IODeviceManager &) = deleted : void
..
+operator=(const IODeviceManager &) = deleted : IODeviceManager &
..
+getDevice(DeviceID id) : VirtualDevice *
+getDevice(DeviceID id) const : const VirtualDevice *
+handleRequest(const IORequest & request) : IOResponse
+pollDevices() : void
+registerDevice(DeviceID id, std::unique_ptr<VirtualDevice> device) : bool
+unregisterDevice(DeviceID id) : bool
__
-_devices : std::unordered_map<DeviceID,std::unique_ptr<VirtualDevice>>
}
class "io::RoutingManager" as C_0005273847708888915350
class C_0005273847708888915350 {
+RoutingManager(IODeviceManager & deviceManager) : void
..
+clearOverrideHandler() : void
+deviceManager() : IODeviceManager &
+deviceManager() const : const IODeviceManager &
+handleRequest(const IORequest & request) : IOResponse
+hasOverrideHandler() const : bool
+setOverrideHandler(IRequestHandler * handler) : void
__
-_deviceManager : IODeviceManager &
-_overrideHandler : IRequestHandler *
}
abstract "io::ITransport" as C_0015529497257294770104
abstract C_0015529497257294770104 {
+~ITransport() constexpr = default : void
..
+poll() : void
{abstract} +receive(IORequest & outReq) = 0 : bool
{abstract} +send(const IOResponse & resp) = 0 : void
__
}
class "io::IOService" as C_0007645722238685656096
class C_0007645722238685656096 {
+IOService(IRequestHandler & handler) : void
..
+addTransport(ITransport * transport) : void
+serviceOnce() : void
__
-_handler : IRequestHandler &
-_transports : std::vector<ITransport *>
}
abstract "io::Channel" as C_0008542343802949846318
abstract C_0008542343802949846318 {
+~Channel() constexpr = default : void
..
{abstract} +available() = 0 : bool
{abstract} +read(std::uint8_t * buffer, std::size_t maxLen) = 0 : std::size_t
{abstract} +write(const std::uint8_t * buffer, std::size_t len) = 0 : void
__
}
class "io::ProtocolRegistry" as C_0011868125949252482179
class C_0011868125949252482179 {
+create(std::string_view schemeLower) const : std::unique_ptr<INetworkProtocol>
+register_scheme(std::string schemeLower, Factory factory) : bool
__
-_factories : std::unordered_map<std::string,Factory>
}
class "io::NetworkDevice" as C_0006245826437162508923
class C_0006245826437162508923 {
+NetworkDevice(ProtocolRegistry registry) : void
..
-close_and_free(Session & s) noexcept : void
+handle(const IORequest & request) : IOResponse
{static} -handle_generation(std::uint16_t h) noexcept : std::uint8_t
{static} -handle_index(std::uint16_t h) noexcept : std::uint8_t
{static} -make_handle(std::uint8_t idx, std::uint8_t gen) noexcept : std::uint16_t
-pick_lru_victim() noexcept : Session *
+poll() : void
-touch(Session & s) noexcept : void
__
{static} -IDLE_TIMEOUT_TICKS : const std::uint64_t
{static} -MAX_SESSIONS : const std::size_t
{static} -NETPROTO_VERSION : const std::uint8_t
-_registry : ProtocolRegistry
-_sessions : std::array<Session,MAX_SESSIONS>
-_tickNow : std::uint64_t
}
class "io::NetworkDevice::Session" as C_0011301425670680674257
class C_0011301425670680674257 {
__
+active : bool
+awaitingBody : bool
+completed : bool
+createdTick : std::uint64_t
+expectedBodyLen : std::uint32_t
+flags : std::uint8_t
+generation : std::uint8_t
+lastActivityTick : std::uint64_t
+method : std::uint8_t
+nextBodyOffset : std::uint32_t
+proto : std::unique_ptr<INetworkProtocol>
+receivedBodyLen : std::uint32_t
+url : std::string
}
class "io::ClockDevice" as C_0006193474076654383504
class C_0006193474076654383504 {
+handle(const IORequest & request) : IOResponse
+poll() : void
__
}
class "io::bytecodec::Reader" as C_0001552565821524910243
class C_0001552565821524910243 {
+Reader(const std::uint8_t * data, std::size_t size) : void
..
+ok() const : bool
+pos() const : std::size_t
+read_bytes(const std::uint8_t *& ptr, std::size_t n) : bool
+read_lp_u16_string(std::string_view & out) : bool
+read_sv(std::string_view & out, std::size_t n) : bool
+read_u16le(std::uint16_t & out) : bool
+read_u32le(std::uint32_t & out) : bool
+read_u64le(std::uint64_t & out) : bool
+read_u8(std::uint8_t & out) : bool
+remaining() const : std::size_t
+skip(std::size_t n) : bool
__
-_begin : const std::uint8_t *
-_end : const std::uint8_t *
-_p : const std::uint8_t *
}
enum "io::ClockCommand" as C_0006646916694369797139
enum C_0006646916694369797139 {
GetTime
SetTime
}
class "io::FileDevice" as C_0018348317585229177251
class C_0018348317585229177251 {
+FileDevice(fs::StorageManager & storage) : void
..
+handle(const IORequest & request) : IOResponse
-handle_list_directory(const IORequest & request) : IOResponse
-handle_read_file(const IORequest & request) : IOResponse
-handle_stat(const IORequest & request) : IOResponse
-handle_write_file(const IORequest & request) : IOResponse
+poll() : void
__
-_storage : fs::StorageManager &
}
class "io::CommonPrefix" as C_0010415374062290681357
class C_0010415374062290681357 {
__
+fs : std::string
+path : std::string
}
class "io::StubNetworkProtocol" as C_0011683483391837494806
class C_0011683483391837494806 {
+close() : void
+info(NetworkInfo & out) : StatusCode
+open(const NetworkOpenRequest & req) : StatusCode
+poll() : void
+read_body(std::uint32_t offset, std::uint8_t * out, std::size_t outLen, std::uint16_t & read, bool & eof) : StatusCode
+write_body(std::uint32_t offset, const std::uint8_t * data, std::size_t dataLen, std::uint16_t & written) : StatusCode
__
-_body : std::vector<std::uint8_t>
-_contentLength : std::uint64_t
-_headersBlock : std::string
-_httpStatus : std::uint16_t
-_openReq : NetworkOpenRequest
-_requestBody : std::vector<std::uint8_t>
}
class "io::FujiDevice" as C_0016024516082849980408
class C_0016024516082849980408 {
+FujiDevice(ResetHandler resetHandler, std::unique_ptr<config::FujiConfigStore> configStore, fs::StorageManager & storage) : void
..
+config() const : const config::FujiConfig &
+handle(const IORequest & request) : IOResponse
-handle_reset(const IORequest & request) : IOResponse
-handle_unknown(const IORequest & request) : IOResponse
-load_config() : void
+poll() : void
-save_config() : void
+start() : void
__
-_config : config::FujiConfig
-_configStore : std::unique_ptr<config::FujiConfigStore>
-_resetHandler : ResetHandler
-_storage : fs::StorageManager &
}
class "io::FujiBusTransport" as C_0003433839086217597071
class C_0003433839086217597071 {
+FujiBusTransport(Channel & channel) : void
..
+poll() : void
+receive(IORequest & outReq) : bool
+receiveResponse(IOResponse & outResp) : bool
+send(const IOResponse & resp) : void
__
-_channel : Channel &
-_nextRequestId : RequestID
-_rxBuffer : std::vector<std::uint8_t>
}
class "core::EventStream<EventT>" as C_0005138967228563115798
class C_0005138967228563115798 {
+publish(const EventT & ev) : void
+subscribe(Callback cb) : Subscription
+unsubscribe(Subscription sub) : void
__
-_mx : std::mutex
-_nextId : std::uint32_t
-_subs : std::vector<Subscriber>
}
class "core::EventStream::Subscription" as C_0001165583155332036678
class C_0001165583155332036678 {
__
+id : std::uint32_t
}
class "core::EventStream::Subscriber" as C_0006794901728867494679
class C_0006794901728867494679 {
__
+cb : Callback
+id : std::uint32_t
}
class "core::EventStream<net::NetworkEvent>" as C_0002040917693353561204
class C_0002040917693353561204 {
__
}
class "core::EventStream<time::TimeEvent>" as C_0006289034866210007341
class C_0006289034866210007341 {
__
}
class "core::SystemEvents" as C_0010820187132968979160
class C_0010820187132968979160 {
+network() noexcept : core::EventStream<net::NetworkEvent> &
+network() const noexcept : const core::EventStream<net::NetworkEvent> &
+time() noexcept : core::EventStream<time::TimeEvent> &
+time() const noexcept : const core::EventStream<time::TimeEvent> &
__
-_network : EventStream<net::NetworkEvent>
-_time : EventStream<time::TimeEvent>
}
class "core::FujinetCore" as C_0011474842863539673819
class C_0011474842863539673819 {
+FujinetCore() : void
..
+addTransport(io::ITransport * transport) : void
+deviceManager() : io::IODeviceManager &
+deviceManager() const : const io::IODeviceManager &
+events() : SystemEvents &
+events() const : const SystemEvents &
+ioService() : io::IOService &
+ioService() const : const io::IOService &
+routingManager() : io::RoutingManager &
+routingManager() const : const io::RoutingManager &
+storageManager() : fs::StorageManager &
+storageManager() const : const fs::StorageManager &
+tick() : void
+tick_count() const noexcept : std::uint64_t
__
-_deviceManager : io::IODeviceManager
-_events : SystemEvents
-_ioService : io::IOService
-_routing : io::RoutingManager
-_storageManager : fs::StorageManager
-_tickCount : std::uint64_t
}
class "fs::StorageManager" as C_0001279065520068563954
class C_0001279065520068563954 {
+StorageManager() = default : void
+StorageManager(const StorageManager &) = deleted : void
+~StorageManager() = default : void
..
+operator=(const StorageManager &) = deleted : StorageManager &
..
+get(const std::string & name) : IFileSystem *
+get(const std::string & name) const : const IFileSystem *
+listNames() const : std::vector<std::string>
+registerFileSystem(std::unique_ptr<IFileSystem> fs) : bool
+unregisterFileSystem(const std::string & name) : bool
__
-_fileSystems : std::unordered_map<std::string,std::unique_ptr<IFileSystem>>
}
C_0002386736627821114488 o-- C_0015173710654558847960 : +type
C_0002942984525013396621 o-- C_0012496700434923238249 : +status
C_0010613333864250568344 ..> C_0001159279330674149840
C_0010613333864250568344 ..> C_0012496700434923238249
C_0010613333864250568344 ..> C_0007100525671922339382
C_0007350464861923755413 ..> C_0002386736627821114488
C_0007350464861923755413 ..> C_0002942984525013396621
C_0010069830097413987109 ..> C_0002386736627821114488
C_0010069830097413987109 ..> C_0002942984525013396621
C_0010794218937492142358 ..> C_0010069830097413987109
C_0010794218937492142358 ..> C_0002386736627821114488
C_0010794218937492142358 ..> C_0002942984525013396621
C_0007350464861923755413 <|-- C_0010794218937492142358
C_0005273847708888915350 ..> C_0002386736627821114488
C_0005273847708888915350 ..> C_0002942984525013396621
C_0005273847708888915350 --> C_0010794218937492142358 : -_deviceManager
C_0005273847708888915350 --> C_0007350464861923755413 : -_overrideHandler
C_0007350464861923755413 <|-- C_0005273847708888915350
C_0015529497257294770104 ..> C_0002386736627821114488
C_0015529497257294770104 ..> C_0002942984525013396621
C_0007645722238685656096 ..> C_0015529497257294770104
C_0007645722238685656096 --> C_0007350464861923755413 : -_handler
C_0011868125949252482179 ..> C_0010613333864250568344
C_0006245826437162508923 ..> C_0002386736627821114488
C_0006245826437162508923 ..> C_0002942984525013396621
C_0006245826437162508923 ..> C_0011301425670680674257
C_0006245826437162508923 o-- C_0011868125949252482179 : -_registry
C_0010069830097413987109 <|-- C_0006245826437162508923
C_0011301425670680674257 --+ C_0006245826437162508923
C_0006193474076654383504 ..> C_0002386736627821114488
C_0006193474076654383504 ..> C_0002942984525013396621
C_0010069830097413987109 <|-- C_0006193474076654383504
C_0018348317585229177251 ..> C_0002386736627821114488
C_0018348317585229177251 ..> C_0002942984525013396621
C_0018348317585229177251 --> C_0001279065520068563954 : -_storage
C_0010069830097413987109 <|-- C_0018348317585229177251
C_0011683483391837494806 ..> C_0012496700434923238249
C_0011683483391837494806 ..> C_0007100525671922339382
C_0011683483391837494806 o-- C_0001159279330674149840 : -_openReq
C_0010613333864250568344 <|-- C_0011683483391837494806
C_0016024516082849980408 ..> C_0002386736627821114488
C_0016024516082849980408 ..> C_0002942984525013396621
C_0016024516082849980408 --> C_0001279065520068563954 : -_storage
C_0010069830097413987109 <|-- C_0016024516082849980408
C_0003433839086217597071 ..> C_0002386736627821114488
C_0003433839086217597071 ..> C_0002942984525013396621
C_0003433839086217597071 --> C_0008542343802949846318 : -_channel
C_0015529497257294770104 <|-- C_0003433839086217597071
C_0005138967228563115798 ..> C_0001165583155332036678
C_0001165583155332036678 --+ C_0005138967228563115798
C_0006794901728867494679 --+ C_0005138967228563115798
C_0002040917693353561204 ..|> C_0005138967228563115798
C_0006289034866210007341 ..|> C_0005138967228563115798
C_0010820187132968979160 ..> C_0005138967228563115798
C_0010820187132968979160 o-- C_0002040917693353561204 : -_network
C_0010820187132968979160 o-- C_0006289034866210007341 : -_time
C_0011474842863539673819 ..> C_0015529497257294770104
C_0011474842863539673819 o-- C_0010794218937492142358 : -_deviceManager
C_0011474842863539673819 o-- C_0005273847708888915350 : -_routing
C_0011474842863539673819 o-- C_0007645722238685656096 : -_ioService
C_0011474842863539673819 o-- C_0001279065520068563954 : -_storageManager
C_0011474842863539673819 o-- C_0010820187132968979160 : -_events

'Generated with clang-uml, version 0.6.2
'LLVM version Ubuntu clang version 18.1.3 (1ubuntu1)
@enduml
