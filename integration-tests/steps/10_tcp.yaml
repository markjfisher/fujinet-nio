group: Network / TCP
steps:
  - name: "TCP: sendrecv echo"
    argv: ["{CLI}", "net", "tcp", "sendrecv", "--data", "ping", "--halfclose", "--idle-timeout", "1.0", "{TCP}"]
    expect:
      - "ping"
    timeout_s: 10

  - name: "TCP: sendrecv UTF-8 echo"
    argv:
      - "{CLI}"
      - "net"
      - "tcp"
      - "sendrecv"
      - "--data"
      - '"hÃ©llÃ¶ â€“ ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ ðŸŒ"'
      - "--halfclose"
      - "--idle-timeout"
      - "5"
      - "{TCP}"
    expect:
      # TCP echo should be raw UTF-8; accept either raw or at least a distinctive substring.
      - 'hÃ©llÃ¶ â€“ ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ ðŸŒ'
    timeout_s: 15

  - name: "TCP: sendrecv large payload (>512 bytes)"
    # 768 'B' characters to stress write chunking and RX buffering.
    argv:
      - "{CLI}"
      - "net"
      - "tcp"
      - "sendrecv"
      - "--inp"
      - "integration-tests/data/tcp_large_ascii.txt"
      - "--halfclose"
      - "--idle-timeout"
      - "5"
      - "{TCP}"
    capture:
      mode: "file"
    expect_file:
      path: "{CAPTURED_OUT}"
      contains_text:
        - "^B{768}$"
    timeout_s: 15

  - name: "TCP: URL options parsing (nodelay/keepalive/rx_buf)"
    # This mainly asserts URL parsing accepts query options and that we still echo.
    argv:
      - "{CLI}"
      - "net"
      - "tcp"
      - "sendrecv"
      - "--data"
      - "opts"
      - "--halfclose"
      - "--idle-timeout"
      - "5"
      - "{TCP}?nodelay=1&keepalive=1&rx_buf=4096"
    expect:
      - "opts"
    timeout_s: 15
