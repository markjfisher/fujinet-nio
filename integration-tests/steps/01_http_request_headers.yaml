group: Network / HTTP
steps:
  - name: "HTTP: GET /headers with long request headers from file"
    setup_cmd:
      - argv:
          - "python3"
          - "-c"
          - |
            import os, pathlib
            p = pathlib.Path(os.environ["STEP_TMP"]) / "req_headers.txt"
            long_a = "A" * 400
            long_b = "B" * 400
            p.write_text(
              "X-Long-A=" + long_a + "\n" +
              "X-Long-B: " + long_b + "\n" +
              "X-Wanted=ok\n",
              encoding="utf-8"
            )
            print(str(p))
    argv:
      - "{CLI}"
      - "net"
      - "get"
      - "--set-header-from-file"
      - "{STEP_TMP}/req_headers.txt"
      - "{HTTP}/headers"
    expect:
      - '"X-Long-A": "A{400}"'
      - '"X-Long-B": "B{400}"'
      - '"X-Wanted": "ok"'
    timeout_s: 15

  - name: "HTTP: GET /headers with repeated --set-header"
    argv:
      - "{CLI}"
      - "net"
      - "get"
      - "--set-header"
      - "X-Wanted=ok"
      - "--set-header"
      - "X-Short:hi"
      - "{HTTP}/headers"
    expect:
      - '"X-Wanted": "ok"'
      - '"X-Short": "hi"'
    timeout_s: 10

  - name: "HTTP: response allowlist returns X-Wanted even with huge X-Big"
    argv:
      - "bash"
      - "-lc"
      - |
        python3 - <<'PY' > "{STEP_TMP}/url.txt"
        import os
        big = "Z" * 1900
        print("{HTTP}/response-headers?X-Big=" + big + "&X-Wanted=ok")
        PY
        URL="$(cat "{STEP_TMP}/url.txt")"
        ./scripts/fujinet -p "{PORT}" net head --resp-header X-Wanted "$URL"
    expect:
      - "X-Wanted: ok"
    forbid:
      - "X-Big:"
    timeout_s: 20
