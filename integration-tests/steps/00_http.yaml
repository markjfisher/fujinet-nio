group: Network / HTTP
steps:
  - name: "HTTP: GET /get"
    argv: ["{CLI}", "net", "get", "{HTTP}/get"]
    expect:
      - "url"
      - "/get"
    timeout_s: 10

  - name: "HTTP: HEAD /headers"
    argv: ["{CLI}", "net", "head", "{HTTP}/headers"]
    expect:
      - "http_status"
      - "200|OK|Ok|status"
    timeout_s: 10

  - name: "HTTP: POST /post (body)"
    argv: ["{CLI}", "net", "send", "--method", "2", "--read-response", "--data", "hello", "{HTTP}/post"]
    expect:
      - '"data": "hello"'
    timeout_s: 10

  - name: "HTTP: POST /post (large body >512 bytes)"
    # 768 'A' characters to force multi-chunk write on the device side.
    argv:
      - "{CLI}"
      - "net"
      - "send"
      - "--method"
      - "2"
      - "--read-response"
      - "--inp"
      - "integration-tests/data/http_large_ascii.txt"
      - "{HTTP}/post"
    capture:
      mode: "file"
    expect_file:
      path: "{CAPTURED_OUT}"
      contains_text:
        # httpbin echoes the body in JSON as "data": "<...>"
        - '"data": "A{768}"'
    timeout_s: 15

  - name: "HTTP: POST /post (UTF-8 body)"
    argv:
      - "{CLI}"
      - "net"
      - "send"
      - "--method"
      - "2"
      - "--read-response"
      - "--data"
      - '"h√©ll√∂ ‚Äì „Åì„Çì„Å´„Å°„ÅØ‰∏ñÁïå üåç ‚Äî caf√© na√Øve"'
      - "{HTTP}/post"
    expect:
      # HTTPBIN shows us in ascii what the bytes sent were, but it's not unicode here, but plain ascii of the unicode
      # Only the backslash needs escaping
      - 'h\\u00e9ll\\u00f6 \\u2013 \\u3053\\u3093\\u306b\\u3061\\u306f\\u4e16\\u754c \\ud83c\\udf0d \\u2014 caf\\u00e9 na\\u00efve'
    timeout_s: 15

  - name: "HTTP: POST /post (empty body)"
    argv: ["{CLI}", "net", "send", "--method", "2", "--read-response", "--data", "", "{HTTP}/post"]
    expect:
      - '"data": ""'
    timeout_s: 10

  - name: "HTTP: GET /get (query with UTF-8 percent-encoding)"
    argv: ["{CLI}", "net", "get", "{HTTP}/get?plain=1&utf8=h%C3%A9ll%C3%B6%20%E3%81%93%E3%82%93%E3%81%AB%E3%81%A1%E3%81%AF"]
    expect:
      - '"args"'
      - 'utf8'
    timeout_s: 10

  # HTTPS tests - use local HTTPS proxy with FujiNet Test CA
  # The ?testca=1 flag tells the firmware to use the embedded FujiNet Test CA
  # for certificate verification instead of the public CA bundle.
  - name: "HTTPS: GET /get (local proxy with test CA)"
    argv: ["{CLI}", "net", "get", "{HTTPS}/get?testca=1"]
    expect:
      - '"url"'
      - "/get"
    timeout_s: 15
    skip_if: "{HTTPS_SKIP}"
