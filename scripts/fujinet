#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VENV_DIR="${ROOT}/build/.venv"
ACTIVATE="${VENV_DIR}/bin/activate"

# Ensure uv is available
ensure_uv() {
  if ! uv --version &> /dev/null; then
    echo "[fujinet] uv is required but not found. Installing..."
    if ! pipx install uv &> /dev/null; then
      echo "[fujinet] ERROR: pipx is required to install uv. Install with: python3 -m pip install --user pipx"
      exit 1
    fi
    export PATH="$HOME/.local/bin:$PATH"
  fi
}

ensure_venv() {
  if [[ ! -x "${VENV_DIR}/bin/python" ]]; then
    echo "[fujinet] creating venv at ${VENV_DIR}"
    mkdir -p "$(dirname "${VENV_DIR}")"
    uv venv "${VENV_DIR}"
  fi
}

ensure_synced() {
  # Activate venv and sync dependencies from pyproject.toml (and uv.lock if present)
  # uv sync automatically reads pyproject.toml and installs the project in editable mode
  source "${ACTIVATE}"
  uv sync --active >/dev/null
}

run_cli() {
  exec "${VENV_DIR}/bin/python" -m fujinet_tools.cli "$@"
}

cd "${ROOT}"
ensure_uv
ensure_venv
ensure_synced
run_cli "$@"
