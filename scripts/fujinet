#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VENV_DIR="${ROOT}/build/.venv"
PYPROJECT="${ROOT}/pyproject.toml"
STAMP="${VENV_DIR}/.fujinet_tools_installed"

ensure_venv() {
  if [[ ! -x "${VENV_DIR}/bin/python" ]]; then
    echo "[fujinet] creating venv at ${VENV_DIR}"
    mkdir -p "$(dirname "${VENV_DIR}")"
    python3 -m venv "${VENV_DIR}"
  fi
}

ensure_installed() {
  # If pyproject changed since last install, reinstall.
  local current_hash
  current_hash="$(python3 - <<'PY'
import hashlib, pathlib
p = pathlib.Path("pyproject.toml").read_bytes()
print(hashlib.sha256(p).hexdigest())
PY
)"

  local last_hash=""
  if [[ -f "${STAMP}" ]]; then
    last_hash="$(cat "${STAMP}" || true)"
  fi

  if [[ "${current_hash}" != "${last_hash}" ]]; then
    echo "[fujinet] installing/updating python deps (editable)"
    "${VENV_DIR}/bin/python" -m pip install -U pip >/dev/null
    "${VENV_DIR}/bin/python" -m pip install -e "${ROOT}"
    echo "${current_hash}" > "${STAMP}"
  fi
}

run_cli() {
  exec "${VENV_DIR}/bin/python" -m fujinet_tools.cli "$@"
}

cd "${ROOT}"
ensure_venv
ensure_installed
run_cli "$@"
